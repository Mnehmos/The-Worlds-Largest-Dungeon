---
/**
 * ChatInterface.astro
 * Main chat UI component for interacting with the WLD chat API.
 * Includes message history, input field, loading states, and side-by-side source display.
 * Now with enhanced User/System identifiers (Avatars).
 */

import { marked } from "marked";

interface Props {
  placeholder?: string;
  welcomeMessage?: string;
}

const {
  placeholder = "Ask about the dungeon, rules, monsters...",
  welcomeMessage = "Welcome, adventurer! I am the Dungeon Master. Ask me anything about The World's Largest Dungeon, D&D 5e rules, monsters, spells, or items.",
} = Astro.props;
---

<div class="chat-interface" id="chat-interface">
  <!-- Main Chat Area -->
  <div class="chat-main">
    <!-- Message History -->
    <div
      class="chat-messages"
      id="chat-messages"
      role="log"
      aria-live="polite"
      aria-label="Chat messages"
    >
      <!-- Welcome message -->
      <div class="message message-system">
        <div class="message-identity">
          <div class="avatar system-avatar">üè∞</div>
          <span class="sender-name">System</span>
        </div>
        <div class="message-content">
          <p>{welcomeMessage}</p>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <form class="chat-input-form" id="chat-form">
      <div class="input-wrapper">
        <label for="chat-input" class="visually-hidden">Your message</label>
        <textarea
          id="chat-input"
          name="message"
          class="chat-input"
          placeholder={placeholder}
          rows="1"
          required
          aria-describedby="input-hint"></textarea>
        <span id="input-hint" class="visually-hidden"
          >Press Enter to send, Shift+Enter for new line</span
        >
      </div>
      <button
        type="submit"
        class="chat-submit"
        id="chat-submit"
        aria-label="Send message"
      >
        <span class="submit-icon">‚öîÔ∏è</span>
        <span class="submit-text">Send</span>
      </button>
    </form>

    <!-- Loading Indicator -->
    <div class="chat-loading" id="chat-loading" aria-hidden="true">
      <div class="loading-spinner"></div>
      <span>The dungeon master is pondering...</span>
    </div>

    <!-- Error Display -->
    <div class="chat-error" id="chat-error" role="alert" aria-hidden="true">
      <span class="error-icon">‚ö†Ô∏è</span>
      <span class="error-message" id="error-message"></span>
      <button
        class="error-dismiss"
        id="error-dismiss"
        aria-label="Dismiss error">√ó</button
      >
    </div>
  </div>

  <!-- Source Sidebar -->
  <aside class="source-sidebar" id="source-sidebar" aria-label="Source Details">
    <div class="sidebar-header">
      <h3>Source Details</h3>
      <button
        class="sidebar-close"
        id="sidebar-close"
        aria-label="Close sidebar">√ó</button
      >
    </div>
    <div class="sidebar-content" id="sidebar-content">
      <div class="sidebar-empty">
        <span class="empty-icon">üìú</span>
        <p>Select a source number from the chat to view details here.</p>
      </div>
    </div>
  </aside>
</div>

<style>
  .chat-interface {
    display: flex;
    flex-direction: row;
    height: 100%;
    min-height: 500px;
    max-height: calc(100vh - 200px);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
  }

  /* Main Chat Area */
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    position: relative;
  }

  /* Messages Area */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  /* Sidebar Styling */
  .source-sidebar {
    width: 0;
    background: var(--color-bg-tertiary);
    border-left: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease;
    overflow: hidden;
  }

  .source-sidebar.open {
    width: 350px;
  }

  .sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg-elevated);
    border-bottom: 1px solid var(--color-border);
    min-height: 50px;
  }

  .sidebar-header h3 {
    margin: 0;
    font-size: 1rem;
    font-family: var(--font-display);
    color: var(--color-text-primary);
    white-space: nowrap;
  }

  .sidebar-close {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
  }

  .sidebar-close:hover {
    color: var(--color-text-primary);
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-md);

    /* Ensure content is readable */
    word-break: break-word;
  }

  .sidebar-empty {
    text-align: center;
    color: var(--color-text-muted);
    margin-top: var(--space-xl);
    padding: var(--space-lg);
  }

  .empty-icon {
    font-size: 2rem;
    display: block;
    margin-bottom: var(--space-sm);
    opacity: 0.5;
  }

  /* Source Content in Sidebar */
  :global(.sidebar-source-meta) {
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--color-border-subtle);
  }

  :global(.sidebar-source-badge) {
    display: inline-block;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-right: var(--space-sm);
  }

  :global(.sidebar-source-badge.rag) {
    background: rgba(180, 120, 60, 0.15);
    color: var(--color-accent-secondary);
    border: 1px solid var(--color-accent-secondary);
  }

  :global(.sidebar-source-badge.sqlite) {
    background: rgba(201, 162, 39, 0.15);
    color: var(--color-accent-primary);
    border: 1px solid var(--color-accent-primary);
  }

  :global(.sidebar-source-score) {
    font-size: 0.8rem;
    color: var(--color-success);
    font-weight: 600;
  }

  :global(.sidebar-source-ref) {
    display: block;
    margin-top: var(--space-xs);
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-text-primary);
    word-break: break-all;
  }

  :global(.sidebar-source-text) {
    white-space: pre-wrap;
    font-family: var(--font-body);
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
  }

  :global(.sidebar-source-link) {
    display: inline-block;
    margin-top: var(--space-md);
    color: var(--color-accent-primary);
    font-size: 0.85rem;
    text-decoration: none;
  }

  :global(.sidebar-source-link:hover) {
    text-decoration: underline;
  }

  /* Message Bubbles - UPDATED LAYOUT */
  .message {
    display: flex;
    gap: var(--space-sm);
    max-width: 90%; /* Increased width slightly */
    animation: messageSlideIn 0.3s ease;
    align-items: flex-start; /* Align avatar with top */
  }

  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* User Message: Row Reverse (Right aligned) */
  .message-user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  /* Assistant/System Message: Row (Left aligned) */
  .message-assistant {
    align-self: flex-start;
    flex-direction: row;
  }

  .message-system {
    align-self: center;
    flex-direction: column; /* Center system messages vertically stacked */
    align-items: center;
    max-width: 80%;
  }

  /* Identity Column (Avatar + Name) */
  .message-identity {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    width: 60px; /* Fixed width for alignment */
    flex-shrink: 0;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .user-avatar {
    background: linear-gradient(
      135deg,
      var(--color-accent-secondary) 0%,
      var(--color-accent-primary) 100%
    );
    color: var(--color-bg-primary);
    border: none;
  }

  .assistant-avatar {
    background: var(--color-bg-tertiary);
    color: var(--color-accent-primary);
    border-color: var(--color-accent-primary);
  }

  .sender-name {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    font-weight: 500;
    text-align: center;
    line-height: 1.2;
  }

  /* Content area */
  .message-content {
    padding: var(--space-md);
    border-radius: var(--radius-md);
    line-height: 1.5;
    flex: 1;
    min-width: 0; /* Text wrap fix */
  }

  /* Specific Bubble Styles */
  .message-user .message-content {
    background: linear-gradient(
      135deg,
      var(--color-accent-secondary) 0%,
      var(--color-accent-primary) 100%
    );
    color: var(--color-bg-primary);
    border-bottom-right-radius: var(--radius-sm);
    /* Arrow effect */
    border-top-right-radius: 0;
  }

  .message-assistant .message-content {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-bottom-left-radius: var(--radius-sm);
    /* Arrow effect */
    border-top-left-radius: 0;
  }

  .message-system .message-content {
    background: var(--color-bg-elevated);
    border: 1px dashed var(--color-border);
    text-align: center;
    font-style: italic;
    color: var(--color-text-secondary);
  }

  .message-system .message-identity {
    display: none; /* Hide standard identity for system center messages, or customizing it */
  }

  /* Restore system icon inside content if needed, or style differently */
  .message-system .message-content::before {
    content: "üè∞";
    display: block;
    font-size: 1.5rem;
    margin-bottom: var(--space-xs);
  }

  .message-content p {
    margin: 0;
  }

  .message-content p + p {
    margin-top: var(--space-sm);
  }

  /* Markdown Content Styles */
  .markdown-content {
    line-height: 1.6;
  }

  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4 {
    color: var(--color-accent-primary);
    margin: var(--space-md) 0 var(--space-sm) 0;
    font-family: var(--font-display);
  }

  .markdown-content h1 {
    font-size: 1.5rem;
  }
  .markdown-content h2 {
    font-size: 1.25rem;
  }
  .markdown-content h3 {
    font-size: 1.1rem;
  }
  .markdown-content h4 {
    font-size: 1rem;
  }

  .markdown-content h1:first-child,
  .markdown-content h2:first-child,
  .markdown-content h3:first-child {
    margin-top: 0;
  }

  .markdown-content strong {
    color: var(--color-text-primary);
    font-weight: 600;
  }

  .markdown-content em {
    font-style: italic;
    color: var(--color-text-secondary);
  }

  .markdown-content ul,
  .markdown-content ol {
    margin: var(--space-sm) 0;
    padding-left: var(--space-lg);
  }

  .markdown-content li {
    margin: var(--space-xs) 0;
  }

  .markdown-content li::marker {
    color: var(--color-accent-primary);
  }

  /* Tables */
  .markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-md) 0;
    font-size: 0.9rem;
  }

  .markdown-content th,
  .markdown-content td {
    padding: var(--space-sm);
    border: 1px solid var(--color-border);
    text-align: left;
  }

  .markdown-content th {
    background: var(--color-bg-elevated);
    color: var(--color-accent-primary);
    font-weight: 600;
    font-family: var(--font-display);
  }

  .markdown-content tr:nth-child(even) {
    background: rgba(255, 255, 255, 0.02);
  }

  .markdown-content tr:hover {
    background: rgba(201, 162, 39, 0.05);
  }

  /* Code */
  .markdown-content code {
    background: var(--color-bg-elevated);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 0.875em;
    color: var(--color-accent-secondary);
  }

  .markdown-content pre {
    background: var(--color-bg-elevated);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: var(--space-md) 0;
    border: 1px solid var(--color-border);
  }

  .markdown-content pre code {
    background: none;
    padding: 0;
    font-size: 0.85rem;
  }

  /* Blockquotes */
  .markdown-content blockquote {
    border-left: 3px solid var(--color-accent-primary);
    margin: var(--space-md) 0;
    padding: var(--space-sm) var(--space-md);
    background: rgba(201, 162, 39, 0.05);
    font-style: italic;
    color: var(--color-text-secondary);
  }

  .markdown-content blockquote p {
    margin: 0;
  }

  /* Horizontal Rule */
  .markdown-content hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: var(--space-lg) 0;
  }

  /* Links */
  .markdown-content a {
    color: var(--color-accent-primary);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .markdown-content a:hover {
    color: var(--color-accent-secondary);
  }

  /* Sources - Clickable Buttons */
  .message-sources {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border-subtle);
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
  }

  .sources-label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-right: 4px;
  }

  .source-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    padding: 0 10px;
    background: #c9a227;
    color: #0d0d0d;
    border: 2px solid #e6b800;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 700;
    font-family: "Consolas", monospace;
    cursor: pointer;
    transition: all 0.15s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .source-btn:hover {
    background: #e6b800;
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 4px 8px rgba(201, 162, 39, 0.4);
  }

  .source-btn:active {
    transform: scale(0.95);
  }

  .source-btn.rag {
    background: #8b6914;
    border-color: #c9a227;
  }

  .source-btn.rag:hover {
    background: #a57d1a;
  }

  .source-btn.sqlite {
    background: #c9a227;
    border-color: #e6b800;
  }

  /* Tool Used Badge */
  .tool-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    margin-right: var(--space-xs);
  }

  .tool-badge.sqlite {
    background: rgba(201, 162, 39, 0.15);
    color: var(--color-accent-primary);
    border: 1px solid var(--color-accent-primary);
  }

  .tool-badge.rag {
    background: rgba(180, 120, 60, 0.15);
    color: var(--color-accent-secondary);
    border: 1px solid var(--color-accent-secondary);
  }

  .tool-badge.both {
    background: linear-gradient(
      135deg,
      rgba(201, 162, 39, 0.15) 0%,
      rgba(180, 120, 60, 0.15) 100%
    );
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
  }

  /* Input Form */
  .chat-input-form {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: var(--color-bg-tertiary);
    border-top: 1px solid var(--color-border);
  }

  .input-wrapper {
    flex: 1;
  }

  .chat-input {
    width: 100%;
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 1rem;
    resize: none;
    min-height: 48px;
    max-height: 120px;
    transition:
      border-color var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  .chat-input::placeholder {
    color: var(--color-text-muted);
  }

  .chat-input:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1);
  }

  .chat-submit {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-md) var(--space-lg);
    background: linear-gradient(
      135deg,
      var(--color-accent-secondary) 0%,
      var(--color-accent-primary) 100%
    );
    border: none;
    border-radius: var(--radius-md);
    color: var(--color-bg-primary);
    font-family: var(--font-display);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition:
      transform var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  .chat-submit:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md), var(--shadow-glow);
  }

  .chat-submit:active:not(:disabled) {
    transform: translateY(0);
  }

  .chat-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .submit-icon {
    font-size: 1.1rem;
  }

  /* Loading State */
  .chat-loading {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    box-shadow: var(--shadow-md);
    z-index: 10;
  }

  .chat-loading.visible {
    display: flex;
  }

  .loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-accent-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Error Display */
  .chat-error {
    position: absolute;
    top: var(--space-md);
    left: var(--space-md);
    right: var(--space-md);
    display: none;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: rgba(201, 68, 68, 0.1);
    border: 1px solid var(--color-error);
    border-radius: var(--radius-md);
    color: var(--color-error);
    z-index: 20;
  }

  .chat-error.visible {
    display: flex;
  }

  .error-icon {
    font-size: 1.25rem;
  }

  .error-message {
    flex: 1;
  }

  .error-dismiss {
    background: none;
    border: none;
    color: var(--color-error);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    opacity: 0.7;
    transition: opacity var(--transition-fast);
  }

  .error-dismiss:hover {
    opacity: 1;
  }

  /* Responsive: On mobile, sidebar becomes an overlay */
  @media (max-width: 768px) {
    .chat-interface {
      flex-direction: column;
    }

    .source-sidebar {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      box-shadow: var(--shadow-xl);
    }
  }

  /* Accessibility: Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .message {
      animation: none;
    }
    .source-sidebar {
      transition: none;
    }
  }
</style>

<script>
  /**
   * Chat Interface Client-Side Logic
   * Handles form submission, API calls, message rendering, and sidebar control
   */

  import { marked } from "marked";

  // Configure marked for safe HTML output
  marked.setOptions({
    breaks: true, // Convert \n to <br>
    gfm: true, // GitHub Flavored Markdown
  });

  // Configuration
  const CHAT_API_URL = import.meta.env.CHAT_API_URL || "http://localhost:8080";

  // DOM Elements
  const chatMessages = document.getElementById("chat-messages");
  const chatForm = document.getElementById("chat-form") as HTMLFormElement;
  const chatInput = document.getElementById(
    "chat-input"
  ) as HTMLTextAreaElement;
  const chatSubmit = document.getElementById(
    "chat-submit"
  ) as HTMLButtonElement;
  const chatLoading = document.getElementById("chat-loading");
  const chatError = document.getElementById("chat-error");
  const errorMessage = document.getElementById("error-message");
  const errorDismiss = document.getElementById("error-dismiss");

  // Sidebar Elements
  const sourceSidebar = document.getElementById("source-sidebar");
  const sidebarContent = document.getElementById("sidebar-content");
  const sidebarClose = document.getElementById("sidebar-close");

  // State
  let isLoading = false;
  let currentSources: SourceReference[] = []; // Store sources for sidebar display

  // Types
  interface SourceReference {
    type: "rag" | "sqlite";
    reference: string;
    url: string;
    text?: string;
    score?: number;
  }

  interface ChatResponse {
    answer: string;
    sources: SourceReference[];
    query_type: "semantic" | "structured" | "hybrid";
    tool_used: "sqlite" | "rag" | "both" | "none";
  }

  // Auto-resize textarea
  function autoResize(textarea: HTMLTextAreaElement) {
    textarea.style.height = "auto";
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
  }

  chatInput?.addEventListener("input", () => autoResize(chatInput));

  // Handle Enter key (send) vs Shift+Enter (new line)
  chatInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      chatForm?.requestSubmit();
    }
  });

  // Dismiss error
  errorDismiss?.addEventListener("click", hideError);

  // Close sidebar
  sidebarClose?.addEventListener("click", closeSidebar);

  // Form submission
  chatForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const message = chatInput?.value.trim();
    if (!message || isLoading) return;

    // Add user message to chat
    addMessage(message, "user");

    // Clear input and reset height
    chatInput.value = "";
    autoResize(chatInput);

    // Show loading state
    setLoading(true);
    hideError();
    // Close sidebar on new query to focus on chat
    closeSidebar();

    try {
      const response = await sendMessage(message);
      // Store sources for access
      currentSources = response.sources || [];
      addMessage(
        response.answer,
        "assistant",
        response.sources,
        response.query_type,
        response.tool_used
      );
    } catch (error) {
      showError(
        error instanceof Error ? error.message : "An unexpected error occurred"
      );
    } finally {
      setLoading(false);
    }
  });

  /**
   * Send message to chat API
   */
  async function sendMessage(message: string): Promise<ChatResponse> {
    const response = await fetch(`${CHAT_API_URL}/chat`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ message }),
    });

    if (!response.ok) {
      const errorText = await response.text().catch(() => "Unknown error");
      throw new Error(`Request failed: ${response.status} - ${errorText}`);
    }

    return response.json();
  }

  /**
   * Add a message to the chat display
   */
  function addMessage(
    content: string,
    type: "user" | "assistant" | "system",
    sources?: SourceReference[],
    queryType?: string,
    toolUsed?: "sqlite" | "rag" | "both" | "none"
  ) {
    const messageEl = document.createElement("div");
    messageEl.className = `message message-${type}`;

    // Identity Section (Avatar + Name)
    const identityEl = document.createElement("div");
    identityEl.className = "message-identity";

    const avatarEl = document.createElement("div");
    const nameEl = document.createElement("span");
    nameEl.className = "sender-name";

    if (type === "user") {
      avatarEl.className = "avatar user-avatar";
      avatarEl.textContent = "üë§";
      nameEl.textContent = "You";
    } else if (type === "assistant") {
      avatarEl.className = "avatar assistant-avatar";
      avatarEl.textContent = "üßô‚Äç‚ôÇÔ∏è";
      nameEl.textContent = "Dungeon Master";
    }

    // System messages handle identity via CSS hiding usually, but we can set it
    if (type !== "system") {
      identityEl.appendChild(avatarEl);
      identityEl.appendChild(nameEl);
      messageEl.appendChild(identityEl);
    }

    // Content Section
    const contentEl = document.createElement("div");
    contentEl.className = "message-content";

    // Render markdown for assistant messages, plain text for user
    if (type === "assistant") {
      const markdownHtml = marked.parse(content) as string;
      const markdownWrapper = document.createElement("div");
      markdownWrapper.className = "markdown-content";
      markdownWrapper.innerHTML = markdownHtml;
      contentEl.appendChild(markdownWrapper);
    } else {
      // User messages are plain text
      const paragraphs = content.split("\n\n").filter((p) => p.trim());
      paragraphs.forEach((p) => {
        const pEl = document.createElement("p");
        pEl.textContent = p.trim();
        contentEl.appendChild(pEl);
      });
    }

    // Add tool used badge and source buttons for assistant messages
    if (type === "assistant" && (sources?.length || toolUsed)) {
      const sourcesEl = document.createElement("div");
      sourcesEl.className = "message-sources";

      // Add tool badge first
      if (toolUsed && toolUsed !== "none") {
        const toolBadge = document.createElement("span");
        toolBadge.className = `tool-badge ${toolUsed}`;
        const toolIcon =
          toolUsed === "sqlite" ? "üìä" : toolUsed === "rag" ? "üîç" : "‚ö°";
        const toolLabel =
          toolUsed === "both" ? "SQLite + RAG" : toolUsed.toUpperCase();
        toolBadge.innerHTML = `${toolIcon} ${toolLabel}`;
        sourcesEl.appendChild(toolBadge);
      }

      // Add source buttons
      if (sources && sources.length > 0) {
        const label = document.createElement("span");
        label.className = "sources-label";
        label.textContent = "Sources:";
        sourcesEl.appendChild(label);

        sources.forEach((source, index) => {
          const btn = document.createElement("button");
          btn.className = `source-btn ${source.type}`;
          btn.textContent = `${index + 1}`;
          btn.title = source.reference;
          // IMPORTANT: Update to open sidebar instead of modal
          btn.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent bubbling
            showSourceInSidebar(index);
          });
          sourcesEl.appendChild(btn);
        });
      }

      contentEl.appendChild(sourcesEl);
    }

    messageEl.appendChild(contentEl);
    chatMessages?.appendChild(messageEl);

    // Scroll to bottom
    scrollToBottom();
  }

  /**
   * Display source details in the sidebar
   */
  function showSourceInSidebar(index: number) {
    const source = currentSources[index];
    if (!source) return;

    if (sidebarContent) {
      sidebarContent.innerHTML = `
        <div class="sidebar-source-meta">
          <span class="sidebar-source-badge ${source.type}">${source.type}</span>
          ${source.score !== undefined ? `<span class="sidebar-source-score">${(source.score * 100).toFixed(1)}% Match</span>` : ""}
          <div class="sidebar-source-ref">${source.reference}</div>
        </div>
        <div class="sidebar-source-text">${source.text || "No preview available."}</div>
        <a href="${source.url}" target="_blank" rel="noopener noreferrer" class="sidebar-source-link">üìÇ View on GitHub ‚Üí</a>
      `;
    }

    openSidebar();
  }

  function openSidebar() {
    sourceSidebar?.classList.add("open");
  }

  function closeSidebar() {
    sourceSidebar?.classList.remove("open");
  }

  /**
   * Scroll chat to bottom
   */
  function scrollToBottom() {
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  }

  /**
   * Set loading state
   */
  function setLoading(loading: boolean) {
    isLoading = loading;

    if (chatSubmit) {
      chatSubmit.disabled = loading;
    }

    if (chatLoading) {
      chatLoading.classList.toggle("visible", loading);
      chatLoading.setAttribute("aria-hidden", (!loading).toString());
    }

    if (chatInput) {
      chatInput.disabled = loading;
    }
  }

  /**
   * Show error message
   */
  function showError(message: string) {
    if (errorMessage) {
      errorMessage.textContent = message;
    }
    if (chatError) {
      chatError.classList.add("visible");
      chatError.setAttribute("aria-hidden", "false");
    }
  }

  /**
   * Hide error message
   */
  function hideError() {
    if (chatError) {
      chatError.classList.remove("visible");
      chatError.setAttribute("aria-hidden", "true");
    }
  }

  // Initial scroll to bottom
  scrollToBottom();
</script>

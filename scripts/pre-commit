#!/bin/bash
# =============================================================================
# Git Pre-Commit Hook: Secrets Detection
# =============================================================================
# Prevents commits containing potential API keys or secrets.
# 
# INSTALLATION:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or on Windows (Git Bash):
#   cp scripts/pre-commit .git/hooks/pre-commit

echo "ðŸ” Scanning for secrets..."

# Patterns to detect (adjust as needed)
PATTERNS=(
    'sk-[a-zA-Z0-9]{20,}'           # OpenAI API keys
    'sk-or-v1-[a-zA-Z0-9]{20,}'     # OpenRouter API keys
    'sk-ant-[a-zA-Z0-9]{20,}'       # Anthropic API keys
    'ghp_[a-zA-Z0-9]{36}'           # GitHub Personal Access Tokens
    'gho_[a-zA-Z0-9]{36}'           # GitHub OAuth tokens
    'AKIA[0-9A-Z]{16}'              # AWS Access Key IDs
    'password\s*=\s*["\x27][^"\x27]{8,}["\x27]'  # Hardcoded passwords
)

# Files to exclude from scanning (documentation, examples)
EXCLUDE_PATTERNS=(
    '\.env\.example$'
    'DEPLOYMENT\.md$'
    'README\.md$'
    'ADR-.*\.md$'
    'security_audit\.md$'
    'pre-commit$'
    'secrets-patterns\.txt$'
)

# Build exclude grep pattern
EXCLUDE_GREP=""
for pattern in "${EXCLUDE_PATTERNS[@]}"; do
    EXCLUDE_GREP="$EXCLUDE_GREP -e $pattern"
done

# Get staged files (excluding binary and excluded patterns)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -v $EXCLUDE_GREP 2>/dev/null || git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No files to scan."
    exit 0
fi

# Check each pattern
FOUND_SECRETS=0
for pattern in "${PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | xargs grep -lE "$pattern" 2>/dev/null)
    if [ -n "$MATCHES" ]; then
        echo "âŒ Potential secret detected (pattern: $pattern):"
        echo "$MATCHES" | while read file; do
            echo "   - $file"
            # Show the matching line (redacted)
            grep -nE "$pattern" "$file" 2>/dev/null | head -3 | while read line; do
                echo "     $line" | sed -E 's/(sk-[a-zA-Z0-9]{4})[a-zA-Z0-9]+/\1**REDACTED**/g'
            done
        done
        FOUND_SECRETS=1
    fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "ðŸš« Commit blocked! Remove secrets before committing."
    echo "   If this is a false positive (e.g., documentation), use:"
    echo "   git commit --no-verify"
    exit 1
fi

echo "âœ… No secrets detected."
exit 0
